# テストピラミッド概要

垂直TDDにおけるテスト戦略の基盤となる概念です。

## テストピラミッド図

```
        /\
       /  \  E2E/統合テスト（verify.md / Runbook）
      /----\   - 外部リソース依存（DB、API、ファイルシステム）
     /      \  - 複数コンポーネント結合
    /--------\ - システム全体の動作確認
   /          \
  /------------\ ユニットテスト
 /--------------\  - ビジネスロジック
/----------------\ - 純粋関数、クラスメソッド
                   - 外部依存なし（モック使用）
```

---

## 役割分担

### ユニットテストでカバーすべきもの

- ビジネスロジック（計算、変換、検証）
- 純粋関数（入力→出力、副作用なし）
- クラスメソッド（外部依存をモック）
- エッジケース、バリデーション
- エラーハンドリング

### verify.md（Runbook）でカバーすべきもの

- End-to-Endフロー（UI/CLI → API → DB）
- 外部リソース依存（実際のDB接続、ファイルI/O）
- 複数コンポーネント結合（認証 → API → DB → レスポンス）
- システム全体の動作確認

---

## 原則

**可能な限りユニットテストで検証し、外部依存や結合コストが高いものだけverify.mdで確認する。**

| テスト種別 | 実行速度 | 量 | 目的 |
|-----------|---------|-----|------|
| ユニットテスト | 高速 | 多数 | ビジネスロジックの網羅的検証 |
| 統合テスト（verify.md） | 低速 | 少数 | システム疎通の確認 |

---

## カバレッジ目安

- **ビジネスロジック・純粋関数**: ユニットテストで80%以上カバー
- **verify.md**: End-to-Endフローのみ（外部依存・結合）

---

## よくある問題

**Q: テストピラミッドが崩れている場合（統合テスト >> ユニットテスト）は？**

A: 以下のアプローチを検討：
- リリースブロックではなく、技術的負債として記録
- 次回の開発でユニットテストを追加し、テストピラミッドを改善
- クリティカルなロジックから優先的にユニットテスト化

---

## 関連ステップ

- [Step 2: Runbook & Red](../workflows/step2-runbook-red.md) - verify.md作成
- [Step 4: Logic Meat](../workflows/step4-logic-meat.md) - ユニットテスト実装
